name: Weekly LinkedIn Auto Post

on:
  schedule:
    # Runs every Sunday at 5:00 PM NZST
    - cron: '0 5 * * 0'  # 5:00 AM UTC = 6:00 PM NZDT / 5:00 PM NZST
  
  # Allow manual triggering
  workflow_dispatch:

jobs:
  post-to-linkedin:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Post to LinkedIn
      run: |
        # Create JSON payload for LinkedIn API with properly escaped content
        curl -s -X POST "https://api.linkedin.com/v2/ugcPosts" \
          -H "Authorization: Bearer ${{ secrets.LINKEDIN_ACCESS_TOKEN }}" \
          -H "Content-Type: application/json" \
          -d '{
            "author": "urn:li:person:LFmKmXorjj",
            "lifecycleState": "PUBLISHED",
            "specificContent": {
              "com.linkedin.ugc.ShareContent": {
                "shareCommentary": {
                  "text": "üöÄ Ready to accelerate your AI learning journey?\n\nJoin the AI Builders Community where we turn curiosity into capability through hands-on collaborative projects!\n\n‚ú® What makes us different:\n‚Ä¢ Use case-driven learning (no more tutorial hell!)\n‚Ä¢ Structured pathway from Explorer to Builder\n‚Ä¢ Real-world projects with mockups & wireframes\n‚Ä¢ Safe learning space free of judgment\n‚Ä¢ Community of like-minded AI enthusiasts\n\nWhether you'\''re a complete beginner or looking to upskill, we meet you where you are and help you reach where you want to go.\n\nüéØ Ready to build your AI future?\n\n#AI #ArtificialIntelligence #AILearning #TechCommunity #SkillDevelopment #AIEducation #ProductFoundry #FutureOfWork #MachineLearning #Innovation\n\n‚ú® Ready to start your AI journey? Join our AI Explorers program: https://productfoundry.ai/individuals-ai-explorers"
                },
                "shareMediaCategory": "NONE"
              }
            },
            "visibility": {
              "com.linkedin.ugc.MemberNetworkVisibility": "PUBLIC"
            }
          }' > linkedin_response.json

        # Check response
        RESPONSE=$(cat linkedin_response.json)
        echo "LinkedIn API Response: $RESPONSE"

        # Check if post was successful
        if echo "$RESPONSE" | grep -q '"id"'; then
          echo "‚úÖ LinkedIn post created successfully!"
          POST_ID=$(echo "$RESPONSE" | grep -o '"id":"[^"]*"' | cut -d'"' -f4)
          echo "Post ID: $POST_ID"
          
          # Create success issue for tracking  
          gh issue create \
            --title "‚úÖ LinkedIn Post Created - $(date '+%Y-%m-%d')" \
            --body "LinkedIn post was automatically created on $(date).\n\n**Post ID:** $POST_ID\n\n**API Response:**\n\`\`\`json\n$RESPONSE\n\`\`\`"
        else
          echo "‚ùå LinkedIn post failed!"
          
          # Create failure issue for debugging
          gh issue create \
            --title "‚ùå LinkedIn Post Failed - $(date '+%Y-%m-%d')" \
            --body "LinkedIn post failed on $(date).\n\n**Error Response:**\n\`\`\`json\n$RESPONSE\n\`\`\`\n\nPlease check the LinkedIn access token and API configuration."
          
          exit 1
        fi
        
        # Cleanup
        rm -f linkedin_response.json
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}